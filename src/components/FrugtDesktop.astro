---
const url = import.meta.env.SUPABASE_URL;
const key = import.meta.env.SUPABASE_API_KEY;

const res = await fetch(
  `${url}/rest/v1/categories?select=*,variants(*)`,
  {
    headers: {
      apikey: key,
      Authorization: `Bearer ${key}`,
    },
  }
);

const categories = await res.json();
---

<section class="categories">
  <h2>Læs om de mange forskellige sorter vi dyrker på Esromgaard</h2>

  {
    categories.map((frugt) => (
      <div class="category-item">
        <!-- CARD -->
        <div class="category-card">
          <div class="image-wrapper">
            <img class="lightbox-target" src={frugt.image} alt={frugt.name} />
          </div>

          <div class="category-content">
            <h2>{frugt.name}</h2>
            <p>{frugt.description}</p>
            <p><strong>Sæson: </strong>{frugt.season}</p>
          </div>

          <button class="green-button accordion">
            Vis udvalget <span class="arrow">▶</span>
          </button>
        </div>

        <!-- PANEL WITH VARIANTS -->
        <div class="panel">
            <div class="panel-inner">
          {frugt.variants && frugt.variants.length > 0 && (
            <ul class="variants-list">
              {frugt.variants.map((variant) => (
                <li class="variant-item">
                  <div class="panel-image-wrapper">
                    <img class="lightbox-target" src={variant.image} alt={variant.name} />
                  </div>
                  <h3>{variant.name}</h3>
                  <p>{variant.description}</p>
                </li>
              ))}
            </ul>
          )}
          </div>
        </div>
      </div>
    ))
  }
</section>

<style>
  .categories {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-bottom: 8rem;
  }

  .category-item {
    display: flex;
    flex-direction: column;
  }

  .category-card {
    display: flex;
    flex-direction: row;
    align-items: stretch;
    gap: 2rem;
    position: relative;
    border: 2px solid var(--color-outline);
    border-radius: 20px;
    padding: 24px;
    background: white;
  }

  .image-wrapper {
    width: 40%;
    min-width: 220px;
    height: 220px;
    overflow: hidden;
    border-radius: 20px;
    flex-shrink: 0;
  }

  .image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .panel-image-wrapper {
    width: 100%;
    height: 200px;
    overflow: hidden;
    border-radius: 20px;
    margin-bottom: 1rem;
  }

  .panel-image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .category-content {
    width: calc(60% - 3rem);
    font-size: var(--font-size-s);
    align-self: center;
  }

  .category-card .green-button {
    position: absolute;
    bottom: 0;
    right: 0;
    z-index: 2;
    padding: 0.5rem 2rem;
    border-radius: 20px 0 18px 0;
  }

  .green-button .arrow {
    margin-left: 0.5em;
    transition: transform 220ms ease;
    display: inline-block;
  }

  .panel {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.45s ease;
  padding: 0 1.5rem;
  background-color: white;
  border: 2px solid var(--color-outline);
  border-top: none;
  border-radius: 0 0 20px 20px;
  margin-bottom: 2rem;
  padding-top: 0;
  margin-top: -2rem;
}

.category-item.open .panel {
  padding: 1.5rem;
  padding-top: 5rem;
}

.panel-inner {
  opacity: 0;
  transition: opacity 0s ease;
}

.category-item.open .panel-inner {
  opacity: 1;
}

  .variants-list {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 2rem;
  }

  .variants-list li {
    list-style: none;
  }


  .category-item.open .green-button .arrow {
    transform: rotate(90deg);
  }

  .variants-list {
    margin: 1rem 0 0 0;
    padding-left: 1.5rem;
    list-style: disc;
    font-size: var(--font-size-s);
  }
</style>

<script>
  document.addEventListener("click", function (e) {
    const toggle = e.target.closest(".accordion");
    if (!toggle) return;

    const item = toggle.closest(".category-item");
    if (!item) return;

    const panel = item.querySelector(".panel");
    const isOpening = !item.classList.contains("open");

    item.classList.toggle("open");

    if (isOpening) {
      panel.style.maxHeight = panel.scrollHeight + "px";
    } else {
      panel.style.maxHeight = "0px";
    }
  });
</script>