---
const url = import.meta.env.SUPABASE_URL;
const key = import.meta.env.SUPABASE_API_KEY;

const res = await fetch(`${url}/rest/v1/categories?select=*`, {
  headers: {
    apikey: key,
    Authorization: `Bearer ${key}`,
  },
});

const categories = await res.json();
---

<section class="categories">
  <h2>Læs om de mange forskellige sorter vi dyrker på Esromgaard</h2>

  {
    categories.map((frugt) => (
      <div class="category-item">
        <!-- CARD (image + content + button) -->
        <div class="category-card">
          <div class="image-wrapper">
            <img src={frugt.image} alt={frugt.name} />
          </div>

          <div class="category-content">
            <h2>{frugt.name}</h2>
            <p>{frugt.description}</p>
          </div>

          <button class="green-button accordion">
            Vis udvalget <span class="arrow">▶</span>
          </button>
        </div>

        <div class="panel">
          <h3>Varianter for {frugt.name}</h3>
          <p>(Her loader du senere varianter fra Supabase eller viser statisk indhold.)</p>
        </div>
      </div>
    ))
  }
</section>

<style>
  .categories {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-bottom: 2rem;
  }


  .category-item {
    display: flex;
    flex-direction: column;
  }

  .category-card {
    display: flex;
    flex-direction: row;
    align-items: stretch;
    gap: 2rem;
    position: relative;
    border: 2px solid var(--color-outline);
    border-radius: 20px;
    padding: 24px;
    background: white;
  }

  .image-wrapper {
    width: 40%;
    min-width: 220px;
    height: 220px;
    overflow: hidden;
    border-radius: 20px;
    flex-shrink: 0;
  }

  .image-wrapper img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .category-content {
    width: calc(60% - 3rem);
    font-size: var(--font-size-s);
    align-self: center;
  }

  .category-card .green-button {
    position: absolute;
    bottom: 0;
    right: 0;
    z-index: 2;
    padding: 0.5rem 2rem;
    border-radius: 20px 0 18px 0;
  }

  .green-button .arrow {
    margin-left: 0.5em;
    transition: transform 220ms ease;
    display: inline-block;
  }

  .panel {
    display: none;
    padding: 1.5rem;
    background-color: white;
    border: 2px solid var(--color-outline);
    border-top: none;
    border-radius: 0 0 20px 20px;
    margin-bottom: 2rem;
    padding-top: 5rem;
    margin-top: -2rem;
    top: 10;
  }

  .category-item.open .panel {
    display: block;
  }
  .category-item.open .green-button .arrow {
    transform: rotate(90deg);
  }
</style>

<script>
  // Use event delegation to be defensive if the DOM changes
  document.addEventListener("click", function (e) {
    const toggle = e.target.closest(".accordion");
    if (!toggle) return;

    // find the wrapper (.category-item) that contains the card + panel
    const item = toggle.closest(".category-item");
    if (!item) return;

    // toggle an 'open' class on the wrapper (useful for CSS + ARIA)
    item.classList.toggle("open");

    // Optionally: if you want to animate height instead of show/hide,
    // you can use max-height transitions here. For now we just toggle display via class.
  });
</script>
